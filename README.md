# buildah_debian_container_from_scratch

Create a Debian container from scratch using buildah (as a non-root user).

## Motivation

In a conversation earlier this week,
[Eric Herman](https://github.com/ericherman) mentioned one of his hesitations
about containers is that most examples seem to depend on downloading binary
blobs from public repositories with minimal vetting of the binaries, leading to
many possible security risks, both
[theoretical](https://www.archive.ece.cmu.edu/~ganger/712.fall02/papers/p761-thompson.pdf)
and
[seen in the wild](https://blog.npmjs.org/post/185397814280/plot-to-steal-cryptocurrency-foiled-by-the-npm).
He pointed out that some of the work being done by projects like
[Debian](debian.org) with careful code reviews and
[reproducible builds](https://wiki.debian.org/ReproducibleBuilds)
could help mitigate these risks, but he generally had not seen this approach
taken in the container world.

I pointed out that, in theory, there was no need to download binary images to
use tools such as podman as long as you were willing to build your own base
images.  Realizing I had not done so, however, I decided to try building a
Debian image using buildah as an example. Although I found many good examples
of how to build
[Fedora images from scratch](https://www.server-world.info/en/note?os=Fedora_31&p=buildah&f=2)
with buildah and some examples of how to build
[Ubuntu/Debian images for Docker from scratch](https://docs.docker.com/develop/develop-images/baseimages/)
from scratch, I wasn't able to find a buildah example.  Although the Docker
examples could be modified to work with buildah, they required root privileges
to initialize the container which defeats one of the nice security features in
podman and buildah (working as a non-root user). It took a few tries to figure
out how to work around the root privileges requirement, so I thought it was
worth documenting the solution that I found.

## Prerequisites

This script assumes you have `fakeroot`, `debootstrap`, and `buildah` installed.

  * `fakeroot` can be found in most package managers and is often installed by
    default.
  * The `debootstrap` script is in available in some package managers (e.g.
    Debian/Ubuntu), and can also be
    [installed manually](https://www.linuxquestions.org/questions/debian-26/how-to-install-debian-using-debootstrap-4175465295/).
  * `buildah` is in many package managers but not yet in the Debian/Ubuntu
    mainstream repositories; it can be installed from
    [Debian testing](https://tracker.debian.org/pkg/golang-github-containers-buildah)
    or
    [installed from source or a third-party repository](https://github.com/containers/buildah/blob/master/install.md).

## Usage

To create a new image named `$USER/debian_buster_minbase` where `$USER` is
your username, just run the script:

```bash
./create_debian_minbase_container.sh
```

## A quick code walkthrough

The code is very short and relatively simple. To create a new empty container
using buildah, we just run `buildah from scratch` and store the returned
container-id in a variable:

```bash
container=$(buildah from scratch)
```

We then need to create a standard Debian file system in the container, and we
can use `debootstrap` to do so. This turned out to be a little tricker than it
appeared, however, as `debootstrap` assumes it is being run as root, and will
report an error if it is not. The easiest way around this is just to run
this command using `sudo`, but that violates the
[principle of least privilege](https://en.wikipedia.org/wiki/Principle_of_least_privilege)
and thus is something that is better avoided in a build script.  Luckily we can
fool `debootstrap` into running if we use the `fakeroot` command.  We will get
some errors when it tries to create the `/proc` and `/sys` filesystems, but the
rest of the script will run despite these errors and we won't need these
for our container.

We also need to somehow get the files generated by `debootstrap` into the
container.  The most common approach I saw in the Docker examples was to use
`debootstrap` to create our Debian file system in a temporary directory and
then use the equivalent of `buildah copy` to copy the files into the container.
While this may work when both commands are run with root privileges, it did not
result in a functional system when run with fakeroot (e.g. commands like `apt`
would not work).  Thus, rather than building the Debian file system in a separate
directory, we can use the `buildah mount` command to mount the container's
filesystem and then use `debootstrap` to build a Debian filesystem directly
inside the container.

Trying to mounting the container's filesystem as a non-root user, however,
will fail inside of the standard user namespace. Again, we could use `sudo`
to work around this, but the `buildah` team has created a better solution
with the `buildah unshare` command.  This runs a process in a new user
namespace, allowing commands like `buildah mount` to work.

Putting it all together, we end up with a command that creates a new
(temporary) user namespace, and then within that namespace mounts the
container's filesystem, creates a minimal Debian buster install inside
of that filesystem using `fakeroot debootstrap`, and then unmounts the
filesystem:

```bash
# Unshare is required for buildah mount to work without superuser privileges.
buildah unshare bash -c "\
`# mount the container's filesystem`\
mount_point=\$(buildah mount $container) &&\
`# install a debian minbase installation in the container's filesystem`\
fakeroot debootstrap --variant=minbase --arch=amd64 buster \$mount_point http://deb.debian.org/debian ;\
`# unmount the container's filesystem to clean up`\
buildah unmount $container\
"
```

We then store a snapshot of the container as our new image:

```bash
buildah commit $container $USER/debian_buster_minbase
```

Finally, we delete the container (keeping the new image we created):

```bash
buildah rm $container
```

## Running the container

If you have [podman](https://github.com/containers/libpod) installed, you can
create a new container from the image with an interactive (`-i`) `bash` session
and a terminal (`-t`) with just one command:

```bash
podman run -it $USER/debian_buster_minbase bash
```

You can also use `buildah` to create a new container from the image

```bash
container=$(buildah from $USER/debian_buster_minbase)
```

If you have [runc](https://github.com/opencontainers/runc) installed (available
in most package managers), you can also use `buildah` itself to run the image.

```bash
buildah run $container bash
```

This image can also serve as a useful starting point for more complex images;
for example we could add packages such as apache2 to this second container
we've created:

```bash
buildah run $container apt install -y apache2
```
